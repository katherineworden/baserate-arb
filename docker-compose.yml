version: '3.8'

services:
  # Main combined scanner - runs both instant arb + base rate strategies
  scanner:
    build: .
    container_name: arb-scanner
    restart: unless-stopped
    command: python run_combined.py --instant-interval 300 --baserate-interval 3600
    environment:
      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - KALSHI_API_KEY=${KALSHI_API_KEY}
      - KALSHI_PRIVATE_KEY=${KALSHI_PRIVATE_KEY}
      - KALSHI_API_SECRET=${KALSHI_API_SECRET}

      # Trading config
      - MIN_PROFIT_CENTS=${MIN_PROFIT_CENTS:-2}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-100}
      - MIN_LIQUIDITY=${MIN_LIQUIDITY:-10000}
      - AUTO_EXECUTE=${AUTO_EXECUTE:-false}

      # Scan intervals (seconds)
      - INSTANT_INTERVAL=300      # 5 minutes
      - BASERATE_INTERVAL=3600    # 1 hour

    volumes:
      - ./data:/app/data

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('data/scanner_stats.json') else 1)"]
      interval: 10m
      timeout: 10s
      retries: 3
      start_period: 60s

  # Web UI for monitoring (optional)
  web:
    build: .
    container_name: arb-web
    command: python run.py
    ports:
      - "8000:8000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - KALSHI_API_KEY=${KALSHI_API_KEY}
      - KALSHI_PRIVATE_KEY=${KALSHI_PRIVATE_KEY}
      - KALSHI_API_SECRET=${KALSHI_API_SECRET}
    volumes:
      - ./data:/app/data
    profiles:
      - web  # Only start with: docker-compose --profile web up
    depends_on:
      - scanner

  # Instant-only scanner (lighter, more frequent)
  instant-only:
    build: .
    container_name: arb-instant
    restart: unless-stopped
    command: python run_combined.py --instant --instant-interval 60
    environment:
      - KALSHI_API_KEY=${KALSHI_API_KEY}
      - KALSHI_PRIVATE_KEY=${KALSHI_PRIVATE_KEY}
      - KALSHI_API_SECRET=${KALSHI_API_SECRET}
      - MIN_LIQUIDITY=${MIN_LIQUIDITY:-5000}
    volumes:
      - ./data:/app/data
    profiles:
      - instant  # Start with: docker-compose --profile instant up
